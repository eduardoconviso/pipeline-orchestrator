name: AST Scan Orchestrator

on:
  workflow_dispatch:
    inputs:
      repo_full_name:
        description: 'Repository to scan (owner/repo)'
        required: true
        type: string
      branch:
        description: 'Branch that was merged'
        required: true
        type: string
      commit_sha:
        description: 'Merge commit SHA'
        required: true
        type: string
      pr_number:
        description: 'Pull request number'
        required: true
        type: string
      api_url:
        description: 'Conviso Platform API URL'
        required: false
        type: string
        default: 'https://app.convisoappsec.com'

jobs:
  run-ast-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout target repository
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.repo_full_name }}
          ref: ${{ inputs.branch }}
          
      - name: Run Conviso AST
        run: |
          echo "Running AST scan for ${{ inputs.repo_full_name }}"
          echo "Branch: ${{ inputs.branch }}"
          echo "Commit: ${{ inputs.commit_sha }}"
          echo "PR: ${{ inputs.pr_number }}"
          
          # Install Conviso CLI (adjust based on your setup)
          # curl -sSL https://cli.convisoappsec.com/install.sh | bash
          
          # Run the scan
          # conviso ast run --vulnerability-auto-close
          
      - name: Report results
        if: always()
        run: |
          echo "Scan completed for PR #${{ inputs.pr_number }}"
          # Add logic to report back to Conviso Platform if needed
