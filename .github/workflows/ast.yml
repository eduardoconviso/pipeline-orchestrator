name: AST Scan Orchestrator

on:
  workflow_dispatch:
    inputs:
      repo_full_name:
        description: 'Repository to scan (owner/repo)'
        required: true
        type: string
      branch:
        description: 'Branch that was merged'
        required: true
        type: string
      commit_sha:
        description: 'Merge commit SHA'
        required: true
        type: string
      pr_number:
        description: 'Pull request number'
        required: true
        type: string
      api_url:
        description: 'Conviso Platform API URL'
        required: false
        type: string
        default: 'https://app.convisoappsec.com'

jobs:
  run-ast-scan:
    runs-on: ubuntu-latest
    container:
      # Corrected image name from the Docker Hub link you provided
      image: convisoappsec/convisocli:latest
      env:
        CONVISO_API_KEY: ${{ secrets.CONVISO_API_KEY }}
        CONVISO_PLATFORM_URL: ${{ inputs.api_url }}

    steps:
      - name: Checkout target repository
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.repo_full_name }}
          ref: ${{ inputs.branch }}
          fetch-depth: 0

      - name: Run Conviso AST Scan
        run: |
          echo "Starting AST scan for ${{ inputs.repo_full_name }}"
          # Running AST scan without security gate enforcement (non-blocking)
          conviso --company-id 520 ast run --vulnerability-auto-close

      - name: Report results
        if: always()
        run: |
          echo "Scan process finished for PR #${{ inputs.pr_number }}"
